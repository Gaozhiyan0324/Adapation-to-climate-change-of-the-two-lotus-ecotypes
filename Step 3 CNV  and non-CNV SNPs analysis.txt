#####step 1  CNV and non-CNV SNP analysis in R

##Filtering VCF for missing data
fl<-"125lotus.1SNPID.2no_missindel.vcf"
parrot<-readVCF(fl,verbose=F)

##Assessing the relatedness among samples and heterozygosity within
rels<-relatedness(parrot)
head(rels)

pops<-substr(colnames(parrot)[-c(1:9)],1,2) #population codes (the first two letters of the sample names)
hz<-h.zygosity(parrot,pops=pops)
head(hz)

##Generating allele depth tables and normalized depth values
ad.tab<-hetTgen(parrot,info.type="AD")
ad.tab[1:10,1:6]

#the genotype table is needed for correcting the genotype mismatches
gt<-hetTgen(parrot,info.type = "GT")
ad.tab<-ad.correct(ad.tab,gt.table = gt)

##normalize depth table with cpm.normal()
ad.nor<-cpm.normal(ad.tab,method="MedR")

##X is the corrected non-normalized allele depth table and x.norm is the normalized allele depth table
A.info<-allele.info(X=ad.tab,x.norm = ad.nor, plot.allele.cov = TRUE,Fis=Fis)
head(A.info)

##Fis is calculated as before using h.zygosity()
dvs<-dupGet(A.info,test = c("z.05","chi.05"),Fis=Fis)

deviants<-dupGet(A.info,Fis=Fis,test = c("z.all","chi.all"),plot=TRUE,verbose = TRUE)
head(deviants)

CV<-cnv(A.info, test=c("z.05","chi.05"), filter = "kmeans")
# see the difference between deviants and duplicates
table(deviants$dup.stat)
table(CV$dup.stat)

